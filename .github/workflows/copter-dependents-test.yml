# This workflow was generated by Claude (Anthropic AI), not by the repository owner.
#
# Tests downstream compatibility by running cargo-copter against top dependents.
# Useful for crate authors to verify their changes don't break dependent crates.

name: Dependents Compatibility Test

on:
  workflow_dispatch:
    inputs:
      crate_path:
        description: 'Path to the crate to test (default: current directory)'
        required: false
        default: '.'
      top_dependents:
        description: 'Number of top dependents to test'
        required: false
        default: '10'
      patch_transitive:
        description: 'Patch all transitive dependencies'
        required: false
        default: 'true'
      specific_dependents:
        description: 'Specific dependents to test (comma-separated, overrides top_dependents)'
        required: false
        default: ''

jobs:
  test-dependents:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install cargo-copter
        run: cargo binstall cargo-copter --no-confirm

      - name: Run cargo-copter (top dependents)
        if: ${{ inputs.specific_dependents == '' }}
        run: |
          FLAGS=""
          if [ "${{ inputs.patch_transitive }}" = "true" ]; then
            FLAGS="--patch-transitive"
          fi
          cargo-copter \
            --path "${{ inputs.crate_path }}" \
            --top-dependents "${{ inputs.top_dependents }}" \
            --only-check \
            $FLAGS

      - name: Run cargo-copter (specific dependents)
        if: ${{ inputs.specific_dependents != '' }}
        run: |
          FLAGS=""
          if [ "${{ inputs.patch_transitive }}" = "true" ]; then
            FLAGS="--patch-transitive"
          fi
          # Convert comma-separated to space-separated
          DEPS=$(echo "${{ inputs.specific_dependents }}" | tr ',' ' ')
          cargo-copter \
            --path "${{ inputs.crate_path }}" \
            --dependents $DEPS \
            --only-check \
            $FLAGS

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: copter-report
          path: copter-report/
