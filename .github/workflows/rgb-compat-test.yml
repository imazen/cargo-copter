# This workflow was generated by Claude (Anthropic AI), not by the repository owner.
#
# Example workflow for testing rgb crate compatibility.
# Tests against known problematic crates plus top 5 by downloads.

name: RGB Crate Compatibility Test

on:
  workflow_dispatch:
    inputs:
      rgb_repo:
        description: 'RGB repository (owner/repo format)'
        required: false
        default: 'lilith/rust-rgb'
      rgb_ref:
        description: 'Git ref for rgb crate (branch, tag, or commit)'
        required: false
        default: 'fix-backward-compat-gray-types'

jobs:
  test-rgb-compat:
    runs-on: ubuntu-latest
    steps:
      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install cargo-copter
        run: cargo binstall cargo-copter --no-confirm

      - name: Clone rgb crate
        run: |
          git clone https://github.com/${{ inputs.rgb_repo }}.git rgb
          cd rgb
          git checkout ${{ inputs.rgb_ref }}

      - name: Test top 5 dependents
        run: |
          cargo-copter \
            --path ./rgb \
            --top-dependents 5 \
            --only-check \
            --patch-transitive

      - name: Test known problematic crates
        run: |
          # These crates have historically broken with rgb changes:
          # - resize: needs Gray.value_mut()
          # - load_image: needs GrayAlpha DerefMut
          # - cavif, dssim: depend on load_image
          # - image, gifski: have transitive rgb deps
          cargo-copter \
            --path ./rgb \
            --dependents resize load_image cavif dssim image gifski \
            --only-check \
            --patch-transitive

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rgb-copter-report
          path: copter-report/
