# Example: Using cargo-copter in your CI
#
# Copy this workflow to your repository's .github/workflows/ directory
# and customize as needed.
#
# This workflow tests your crate against its reverse dependencies
# to catch breaking changes before publishing.

name: Reverse Dependency Check

on:
  # Run on PRs to catch breaking changes early
  pull_request:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

  # Run on pushes to main for tracking
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

  # Allow manual runs
  workflow_dispatch:
    inputs:
      top-dependents:
        description: 'Number of dependents to test'
        required: false
        default: '10'

permissions:
  contents: read

jobs:
  # Quick check on PRs (fewer dependents, check-only)
  pr-check:
    name: Quick Dependency Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run cargo-copter (quick)
        uses: imazen/cargo-copter@v1
        with:
          top-dependents: 3
          only-check: true
          fail-on-regression: true

  # Thorough check on main branch
  full-check:
    name: Full Dependency Check
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run cargo-copter (full)
        id: copter
        uses: imazen/cargo-copter@v1
        with:
          top-dependents: ${{ github.event.inputs.top-dependents || '10' }}
          fail-on-regression: true

      - name: Summary
        if: always()
        run: |
          echo "## Cargo Copter Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.copter.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regressed | ${{ steps.copter.outputs.regressed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Broken (baseline) | ${{ steps.copter.outputs.broken }} |" >> $GITHUB_STEP_SUMMARY
